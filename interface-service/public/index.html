<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Printing Model Shop</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/index.css">
</head>
<body>
    <!-- Navigation Bar -->
    <nav>
        <div class="navbar">
            <div class="logo">
                <a href="index.html">3D Model Shop</a>
            </div>
            <div class="nav-links">
                <ul>
                    <li><a href="catalog.html" class="nav-link" id="catalogLink">Add</a></li>
                    <!-- If logged in, show username and the settings icon, else show login/register -->
                    <li id="login-register-link" style="display: none;"><a href="login.html">Login</a> / <a href="register.html">Register</a></li>
                    <li id="user-settings" style="display: none;">
                        <span id="username"></span> 
                        <span id="settings-icon">&#9881;</span> <!-- Gear icon -->
                        <div id="settings-dropdown" class="dropdown">
                            <a href="profile.html">Profile</a>
                            <a href="#" id="logout-link">Logout</a>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Header Section -->
    <div class="hero">
        <h1>Welcome to 3D Model Shop</h1>
        <p>Explore, customize, and print your favorite 3D models!</p>
    </div>

    <!-- Search Bar Section -->
    <div class="search-bar">
        <input type="text" id="searchQuery" placeholder="Buscar modelo...">
        <input type="text" id="creatorFilter" placeholder="Filtrar por creador...">

        <div class="search-options">
            <label for="sortBy">Ordenar por:</label>
            <select id="sortBy">
                <option value="name">Nombre</option>
                <option value="price">Precio</option>
            </select>

            <label for="order">Orden:</label>
            <select id="order">
                <option value="asc">Ascendente</option>
                <option value="desc">Descendente</option>
            </select>
        </div>

        <button onclick="searchModels()">游댌 Buscar</button>
    </div>

    <!-- Recommended Models Section (Currently Empty) -->
    <div class="section">
        <h2>Recommended</h2>
        <div class="container" id="recommended-container">
            <!-- Recommended models will be inserted here later -->
        </div>
    </div>

    <!-- Modal -->
    <div id="modelDetailsModal" class="modal">
        <div class="modal-content">
            <span id="closeModal" class="close">&times;</span>
            <div id="modelDetails"></div>
        </div>
    </div>

    <!-- Catalog Section -->
    <div class="section">
        <h2>Catalog</h2>
        <div class="container" id="catalog-container">
            <!-- Catalog items will be dynamically inserted here -->
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <p>&copy; 2025 3D Model Shop. All rights reserved.</p>
    </footer>

    <script src="config.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        const catalogContainer = document.querySelector('#catalog-container');
        try {
            // Cargar todos los modelos en el cat치logo
            const response = await fetch('/models');
            const data = await response.json();

            if (data.models && data.models.length > 0) {
                catalogContainer.innerHTML = ''; // Limpiar contenido anterior
                data.models.forEach(model => {
                    const card = document.createElement('div');
                    card.classList.add('card');
                    card.innerHTML = `
                        <img src="${model.image_url}" alt="${model.name}">
                        <h3>${model.name}</h3>
                        <p><strong>Created by:</strong> ${model.created_by}</p>
                        <p class="price">$${model.price}</p>
                        <button onclick="window.location.href='details.html?model_id=${model._id}'">View Details</button>
                    `;
                    catalogContainer.appendChild(card);
                });
            } else {
                catalogContainer.innerHTML = '<p>No models available at the moment.</p>';
            }
        } catch (error) {
            console.error('Error fetching models:', error);
            catalogContainer.innerHTML = '<p>Failed to load models. Please try again later.</p>';
        }
    });


    async function searchModels() {
        const query = document.getElementById("searchQuery").value.trim();
        const creator = document.getElementById("creatorFilter").value.trim();
        const sortBy = document.getElementById("sortBy").value;
        const order = document.getElementById("order").value;
        const username = localStorage.getItem('username');  // Obtener el nombre de usuario desde el localStorage

        if (!query || !username) return;

        try {
            // Realizar la b칰squeda
            const response = await fetch(`/search?q=${query}&creator=${creator}&sort=${sortBy}&order=${order}`);
            const data = await response.json();

            // Obtener el nombre y el id del primer modelo en los resultados
            const firstModelName = data.length > 0 ? data[0]._source.name : null;
            const firstModelId = data.length > 0 ? data[0]._id : null;

            // Guardar b칰squeda en Redis con el nombre del primer modelo
            if (firstModelName) {
                await fetch("http://localhost:5006/save-search", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ query, creator, username, firstModelName, firstModelId })  // Enviar firstModelId tambi칠n
                });
            }

            const catalogContainer = document.getElementById("recommended-container");
            catalogContainer.innerHTML = ""; // Limpiar resultados anteriores

            // Crear tarjetas para cada modelo en los resultados de b칰squeda
            data.forEach(model => {
                const item = document.createElement("div");
                item.classList.add("card");  // Usar la clase 'card' para el estilo de tarjeta

                // Aqu칤 a침adimos el contenido dentro de cada tarjeta
                item.innerHTML = `
                    <img src="${model._source.image_url || 'default-image.jpg'}" alt="${model._source.name}">
                    <h3>${model._source.name}</h3>
                    <p>${model._source.description}</p>
                    <p><strong>Created by:</strong> ${model._source.created_by}</p>
                    <p class="price">$${model._source.price}</p>
                    <button onclick="window.location.href='details.html?model_id=${model._id}'">View Details</button>
                `;

                // A침adir la tarjeta al contenedor de recomendados
                catalogContainer.appendChild(item);
            });
        } catch (error) {
            console.error("Error fetching search results:", error);
        }
    }


    async function fetchRecentSearches() {
        const username = localStorage.getItem('username');  // Obtener el nombre de usuario desde el localStorage

        if (!username) return;

        try {
            const response = await fetch("http://localhost:5006/recent-searches?username=" + username);
            const data = await response.json();

            const recommendedContainer = document.getElementById("recommended-container");
            recommendedContainer.innerHTML = "";  // Limpiar los resultados anteriores

            // Llamamos a fetchModelByName para cada b칰squeda reciente
            for (let search of data) {
                await fetchModelByName(search.firstModelName);  // Pasamos el nombre del primer modelo para obtenerlo
            }
        } catch (error) {
            console.error("Error fetching recent searches:", error);
        }
    }

    const existingModels = new Set();

    async function fetchModelByName(firstModelName) {
        try {
            const response = await fetch(`http://localhost:5003/models/${firstModelName}`);
            const data = await response.json();  // Obtenemos la respuesta

            const model = data.model;  // Extraemos el modelo de la respuesta

            if (model) {
                const recommendedContainer = document.getElementById("recommended-container");

                if (!existingModels.has(model.name)) {  // Si el modelo no ha sido agregado, lo mostramos
                    existingModels.add(model.name);  // A침adimos el modelo al conjunto

                    const modelCard = document.createElement("div");
                    modelCard.classList.add("card");
                    modelCard.innerHTML = `
                        <img src="${model.image_url || 'default-image.jpg'}" alt="${model.name}">
                        <h3>${model.name}</h3>
                        <p>${model.description}</p>
                        <p><strong>Created by:</strong> ${model.created_by}</p>
                        <p class="price">$${model.price}</p>
                        <button onclick="window.location.href='details.html?model_id=${model._id}'">View Details</button>
                    `;
                    recommendedContainer.appendChild(modelCard);
                }
            }
        } catch (error) {
            console.error("Error fetching model by name:", error);
        }
    }

    // Llamar a la funci칩n para cargar las b칰squedas recientes cuando se carga la p치gina
    document.addEventListener('DOMContentLoaded', fetchRecentSearches);


        // Check if the user is logged in
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('token');
            const username = localStorage.getItem('username');

            const userSettings = document.getElementById('user-settings');
            const settingsIcon = document.getElementById('settings-icon');
            const settingsDropdown = document.getElementById('settings-dropdown');
            const loginRegisterLink = document.getElementById('login-register-link');
            const logoutLink = document.getElementById('logout-link');
            
            if (token && username) {
                // Show user settings and username if logged in
                document.getElementById('user-settings').style.display = 'block';
                document.getElementById('username').innerText = username;
                document.getElementById('login-register-link').style.display = 'none';
            } else {
                // Show login/register links if not logged in
                document.getElementById('login-register-link').style.display = 'block';
                document.getElementById('user-settings').style.display = 'none';
            }

            // Toggle dropdown visibility when clicking the settings icon
            settingsIcon.addEventListener('click', (event) => {
                event.stopPropagation(); // Prevent the event from propagating

                userSettings.classList.toggle('open');

                if (userSettings.classList.contains('open')) {
                    const rect = settingsIcon.getBoundingClientRect();
                    const dropdownWidth = settingsDropdown.offsetWidth;
                    const screenWidth = window.innerWidth;

                    if (rect.left + dropdownWidth > screenWidth) {
                        settingsDropdown.style.left = `${rect.left - dropdownWidth + settingsIcon.offsetWidth}px`;
                    } else {
                        settingsDropdown.style.left = `${rect.left}px`;
                    }

                    settingsDropdown.style.top = `${rect.bottom + window.scrollY}px`;
                }
            });

            // Logout function
            logoutLink.addEventListener('click', () => {
                localStorage.removeItem('token');
                localStorage.removeItem('username');
                window.location.href = 'index.html'; // Redirect to home after logout
            });

            const sessionApiUrl = window.config.sessionApiUrl;

            // Session verification logic
            document.addEventListener('DOMContentLoaded', async function() {
                const token = localStorage.getItem('token');
                
                if (token) {
                    try {
                        const response = await fetch(`${sessionApiUrl}/api/sessions/verify`, {
                            method: 'GET',
                            headers: { 'Authorization': `Bearer ${token}` }
                        });

                        const data = await response.json();
                        if (response.ok) {
                            console.log("Session is valid", data);
                        } else {
                            alert('Session expired or invalid, please log in again.');
                            localStorage.removeItem('token');
                            window.location.href = 'login.html';
                        }
                    } catch (error) {
                        console.error('Error verifying session:', error);
                    }
                } else {
                    window.location.href = 'login.html';
                }
            });

            // Close the dropdown if clicked outside
            document.addEventListener('click', (event) => {
                if (!userSettings.contains(event.target) && !settingsIcon.contains(event.target)) {
                    userSettings.classList.remove('open');
                }
            });
        });
    </script>
</body>
</html>