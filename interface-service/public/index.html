<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Printing Model Shop</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/index.css">
</head>
<body>
    <!-- Navigation Bar -->
    <nav>
        <div class="navbar">
            <div class="logo">
                <a href="index.html">3D Model Shop</a>
            </div>
            <div class="nav-links">
                <ul>
                    <li><a href="catalog.html" class="nav-link" id="catalogLink">Add</a></li>
                    <!-- If logged in, show username and the settings icon, else show login/register -->
                    <li id="login-register-link" style="display: none;"><a href="login.html">Login</a> / <a href="register.html">Register</a></li>
                    <li id="user-settings" style="display: none;">
                        <span id="username"></span> 
                        <span id="settings-icon">&#9881;</span> <!-- Gear icon -->
                        <div id="settings-dropdown" class="dropdown">
                            <a href="profile.html">Profile</a>
                            <a href="#" id="logout-link">Logout</a>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Header Section -->
    <div class="hero">
        <h1>Welcome to 3D Model Shop</h1>
        <p>Explore, customize, and print your favorite 3D models!</p>
    </div>

    <!-- Catalog Section -->
    <div class="section">
        <h2>Catalog</h2>
        <div class="container" id="catalog-container">
            <!-- Catalog items will be dynamically inserted here -->
        </div>
    </div>

    <!-- Modal -->
    <div id="modelDetailsModal" class="modal">
        <div class="modal-content">
            <span id="closeModal" class="close">&times;</span>
            <div id="modelDetails"></div>
        </div>
    </div>

    <!-- Recommended Models Section (Currently Empty) -->
    <div class="section">
        <h2>Recommended</h2>
        <div class="container" id="recommended-container">
            <!-- Recommended models will be inserted here later -->
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <p>&copy; 2025 3D Model Shop. All rights reserved.</p>
    </footer>

    <script src="config.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const container = document.querySelector('.container');
            try {
                const response = await fetch('/models');
                const data = await response.json();

                if (data.models && data.models.length > 0) {
                    container.innerHTML = ''; // Clears initial content
                    data.models.forEach(model => {
                        const card = document.createElement('div');
                        card.classList.add('card');
                        card.innerHTML = `
                            <img src="${model.image_url}" alt="${model.name}">
                            <h3>${model.name}</h3>
                            <p><strong>Created by:</strong> ${model.created_by}</p>
                            <p class="price">$${model.price}</p>
                            <button onclick="window.location.href='/catalog.html'">View Details</button>
                        `;
                        container.appendChild(card);
                    });
                } else {
                    container.innerHTML = '<p>No models available at the moment.</p>';
                }
            } catch (error) {
                console.error('Error fetching models:', error);
                container.innerHTML = '<p>Failed to load models. Please try again later.</p>';
            }
        });

        // Check if the user is logged in
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('token');
            const username = localStorage.getItem('username');

            const userSettings = document.getElementById('user-settings');
            const settingsIcon = document.getElementById('settings-icon');
            const settingsDropdown = document.getElementById('settings-dropdown');
            const loginRegisterLink = document.getElementById('login-register-link');
            const logoutLink = document.getElementById('logout-link');
            
            if (token && username) {
                // Show user settings and username if logged in
                document.getElementById('user-settings').style.display = 'block';
                document.getElementById('username').innerText = username;
                document.getElementById('login-register-link').style.display = 'none';
            } else {
                // Show login/register links if not logged in
                document.getElementById('login-register-link').style.display = 'block';
                document.getElementById('user-settings').style.display = 'none';
            }

            // Toggle dropdown visibility when clicking the settings icon
            settingsIcon.addEventListener('click', (event) => {
                event.stopPropagation(); // Prevent the event from propagating

                userSettings.classList.toggle('open');

                if (userSettings.classList.contains('open')) {
                    const rect = settingsIcon.getBoundingClientRect();
                    const dropdownWidth = settingsDropdown.offsetWidth;
                    const screenWidth = window.innerWidth;

                    if (rect.left + dropdownWidth > screenWidth) {
                        settingsDropdown.style.left = `${rect.left - dropdownWidth + settingsIcon.offsetWidth}px`;
                    } else {
                        settingsDropdown.style.left = `${rect.left}px`;
                    }

                    settingsDropdown.style.top = `${rect.bottom + window.scrollY}px`;
                }
            });

            // Logout function
            logoutLink.addEventListener('click', () => {
                localStorage.removeItem('token');
                localStorage.removeItem('username');
                window.location.href = 'index.html'; // Redirect to home after logout
            });

            const sessionApiUrl = window.config.sessionApiUrl;

            // Session verification logic
            document.addEventListener('DOMContentLoaded', async function() {
                const token = localStorage.getItem('token');
                
                if (token) {
                    try {
                        const response = await fetch(`${sessionApiUrl}/api/sessions/verify`, {
                            method: 'GET',
                            headers: { 'Authorization': `Bearer ${token}` }
                        });

                        const data = await response.json();
                        if (response.ok) {
                            console.log("Session is valid", data);
                        } else {
                            alert('Session expired or invalid, please log in again.');
                            localStorage.removeItem('token');
                            window.location.href = 'login.html';
                        }
                    } catch (error) {
                        console.error('Error verifying session:', error);
                    }
                } else {
                    window.location.href = 'login.html';
                }
            });

            // Close the dropdown if clicked outside
            document.addEventListener('click', (event) => {
                if (!userSettings.contains(event.target) && !settingsIcon.contains(event.target)) {
                    userSettings.classList.remove('open');
                }
            });
        });
    </script>
</body>
</html>