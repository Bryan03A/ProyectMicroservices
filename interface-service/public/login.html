<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login</title>
  <link rel="stylesheet" href="css/login.css">
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>

  <!-- Navigation Bar -->
  <nav>
    <div class="navbar">
      <div class="logo">
        <a href="index.html">3D Model Shop</a>
      </div>
      <div class="nav-links">
        <ul>
          <li><a href="catalog.html" class="nav-link" id="catalogLink">Add</a></li>
          <!-- When not logged in, show Course... -->
          <li id="course-status-link"></li>
          <!-- When not logged in, show login/register -->
          <li id="login-register-link">
            <span id="course-status">Course...</span> / <a href="register.html">Register</a>
          </li>
          <!-- When logged in, show user settings (hidden by default) -->
          <li id="user-settings" style="display: none;">
            <span id="settings-icon">&#9881;</span>
            <div id="settings-dropdown" class="dropdown">
              <a href="profile.html">Profile</a>
              <a href="#" id="logout-link">Logout</a>
            </div>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="form-container">
    <h2>Login</h2>
    <form id="loginForm">
      <label for="username">Username or Email:</label>
      <input type="text" id="username" required><br>
      <label for="password">Password:</label>
      <input type="password" id="password" required><br>
      <button type="submit">Login</button>
    </form>
    <p>Don't have an account? <a href="register.html">Register here</a></p>
  </div>

  <!-- Footer -->
  <footer>
    <p>&copy; 2025 3D Model Shop. All rights reserved.</p>
  </footer>

  <script src="config.js"></script>

  <script>
    // Setting up active navigation
    document.addEventListener('DOMContentLoaded', function() {
      const links = document.querySelectorAll('.nav-link');
      const currentPage = window.location.pathname.split('/').pop();
      links.forEach(link => {
        if (link.href.includes(currentPage)) {
          link.classList.add('active');
        } else {
          link.classList.remove('active');
        }
      });
    });

    // Define API URLs based on the environment
    const apiUrl = window.location.hostname === 'localhost'
      ? 'http://3.82.92.84:5001'
      : 'http://3.82.92.84:5001';

    const sessionApiUrl = window.config.sessionApiUrl;

    // Handling login form submission
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;

      try {
        // Make the login request
        const response = await fetch(`${apiUrl}/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });

        const data = await response.json();
        console.log("Respuesta JSON del servidor:", data);

        if (response.ok) {
          // Save token and username in localStorage
          localStorage.setItem('token', data.token);
          localStorage.setItem('username', username);

          // Check if a session already exists for the user
          const sessionResponse = await fetch(`${sessionApiUrl}/api/sessions/${username}`, {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${data.token}`
            }
          });

          if (sessionResponse.ok) {
            // Update existing session
            const updateSessionResponse = await fetch(`${sessionApiUrl}/api/sessions/${username}`, {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${data.token}`
              },
              body: JSON.stringify({ data: {} })
            });

            if (updateSessionResponse.ok) {
              window.location.href = 'index.html';
            } else {
              const sessionError = await updateSessionResponse.json();
              alert('Error updating session: ' + sessionError.message);
            }
          } else if (sessionResponse.status === 404) {
            // Create a new session if it does not exist
            const sessionCreationResponse = await fetch(`${sessionApiUrl}/api/sessions`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${data.token}`
              },
              body: JSON.stringify({ data: {} })
            });

            if (sessionCreationResponse.ok) {
              window.location.href = 'index.html';
            } else {
              const sessionError = await sessionCreationResponse.json();
              alert('Error creating session: ' + sessionError.message);
            }
          }
        } else {
          alert('Login failed: ' + data.message);
        }
      } catch (error) {
        alert('Error during login: ' + error);
      }
    });
  </script>
</body>
</html>
