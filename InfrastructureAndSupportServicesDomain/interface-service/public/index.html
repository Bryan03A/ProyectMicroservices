<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Printing Model Shop</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/index.css">
</head>
<body>
    <!-- Navigation Bar -->
    <nav>
        <div class="navbar">
            <div class="logo">
                <a href="index.html">3D Model Shop</a>
            </div>
            <div class="nav-links">
                <ul>
                    <li><a href="orders.html" class="nav-link-order" id="ordersLink">Orders</a></li>
                    <li><a href="catalog.html" class="nav-link" id="catalogLink">Add</a></li>
                    <!-- If logged in, show username and the settings icon, else show login/register -->
                    <li id="login-register-link" style="display: none;"><a href="login.html">Login</a> / <a href="register.html">Register</a></li>
                    <li id="user-settings" style="display: none;">
                        <span id="username"></span> 
                        <span id="settings-icon">&#9881;</span> <!-- Gear icon -->
                        <div id="settings-dropdown" class="dropdown">
                            <a href="profile.html">Profile</a>
                            <a href="#" id="logout-link">Logout</a>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Header Section -->
    <div class="hero">
        <h1>Welcome to 3D Model Shop</h1>
        <p>Explore, customize, and print your favorite 3D models!</p>
    </div>

    <!-- Search Bar Section -->
    <div class="search-bar">
        <input type="text" id="searchQuery" placeholder="Search for model...">
        <input type="text" id="creatorFilter" placeholder="Filter by creator...">

        <div class="search-options">
            <label for="sortBy">Sort by:</label>
            <select id="sortBy">
                <option value="name">Name</option>
                <option value="price">Price</option>
            </select>

            <label for="order">Order:</label>
            <select id="order">
                <option value="asc">Ascending</option>
                <option value="desc">Descending</option>
            </select>
        </div>

        <button onclick="searchModels()">üîç Search</button>
    </div>

    <!-- Recommended Models Section (Currently Empty) -->
    <div class="section">
        <h2>Recommended</h2>
        <div class="container" id="recommended-container">
            <!-- Recommended models will be inserted here later -->
        </div>
    </div>

    <!-- Modal -->
    <div id="modelDetailsModal" class="modal">
        <div class="modal-content">
            <span id="closeModal" class="close">&times;</span>
            <div id="modelDetails"></div>
        </div>
    </div>

    <!-- Catalog Section -->
    <div class="section">
        <h2>Catalog</h2>
        <div class="container" id="catalog-container">
            <!-- Catalog items will be dynamically inserted here -->
        </div>
    </div>

    <!-- Button to open/close the iframe -->
    <div class="toggle-button" onclick="toggleIframe()">&#8595;</div>

    <!-- Iframe Container -->
    <div class="iframe-container" id="iframeContainer">
        <iframe src="http://98.83.63.33:5010" frameborder="0"></iframe>
    </div>

    <!-- Footer -->
    <footer>
        <p>&copy; 2025 3D Model Shop. All rights reserved.</p>
    </footer>

    <script src="config.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        const catalogContainer = document.querySelector('#catalog-container');
        try {
            // Load all models in the catalog
            const response = await fetch('/models');
            const data = await response.json();

            if (data.models && data.models.length > 0) {
                catalogContainer.innerHTML = ''; // Clear previous content
                data.models.forEach(model => {
                    const card = document.createElement('div');
                    card.classList.add('card');
                    card.innerHTML = `
                        <img src="${model.image_url}" alt="${model.name}">
                        <h3>${model.name}</h3>
                        <p><strong>Created by:</strong> ${model.created_by}</p>
                        <p class="price">$${model.price}</p>
                        <button onclick="window.location.href='details.html?model_id=${model._id}'">View Details</button>
                    `;
                    catalogContainer.appendChild(card);
                });
            } else {
                catalogContainer.innerHTML = '<p>No models available at the moment.</p>';
            }
        } catch (error) {
            console.error('Error fetching models:', error);
            catalogContainer.innerHTML = '<p>Failed to load models. Please try again later.</p>';
        }
    });

        function toggleIframe() {
            const iframeContainer = document.getElementById('iframeContainer');
            const arrowButton = document.querySelector('.toggle-button');

            // Change the position of the container (slide from the right)
            if (iframeContainer.style.right === '0px') {
                iframeContainer.style.right = '-400px'; // Push the iframe off the screen
                arrowButton.innerHTML = '&#8594;';  // Right arrow
            } else {
                iframeContainer.style.right = '0px';  // Show the iframe
                arrowButton.innerHTML = '&#8592;';  // Left arrow
            }
        }

        async function searchModels() {
            const query = document.getElementById("searchQuery").value.trim();
            const creator = document.getElementById("creatorFilter").value.trim();
            const sortBy = document.getElementById("sortBy").value;
            const order = document.getElementById("order").value;
            const username = localStorage.getItem('username');  // Get username from localStorage

            if (!query || !username) return;

            try {
                // Perform the search
                const response = await fetch(`/search?q=${query}&creator=${creator}&sort=${sortBy}&order=${order}`);
                const data = await response.json();

                // Get the name and ID of the first model in the results
                const firstModelName = data.length > 0 ? data[0]._source.name : null;
                const firstModelId = data.length > 0 ? data[0]._id : null;

                // Save the search to Redis with the name of the first model
                if (firstModelName) {
                    await fetch("http://98.83.63.33:5006/save-search", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ query, creator, username, firstModelName, firstModelId })  // Send firstModelId as well
                    });
                }

                const catalogContainer = document.getElementById("recommended-container");
                catalogContainer.innerHTML = ""; // Clear previous results

                // Create cards for each model in the search results
                data.forEach(model => {
                    const item = document.createElement("div");
                    item.classList.add("card");  // Use the 'card' class for the card style

                    // Here we add the content inside each card
                    item.innerHTML = `
                        <img src="${model._source.image_url || 'default-image.jpg'}" alt="${model._source.name}">
                        <h3>${model._source.name}</h3>
                        <p>${model._source.description}</p>
                        <p><strong>Created by:</strong> ${model._source.created_by}</p>
                        <p class="price">$${model._source.price}</p>
                        <button onclick="window.location.href='details.html?model_id=${model._id}'">View Details</button>
                    `;

                    // Add the card to the recommended container
                    catalogContainer.appendChild(item);
                });
            } catch (error) {
                console.error("Error fetching search results:", error);
            }
        }


        async function fetchRecentSearches() {
            const username = localStorage.getItem('username');  // Get username from localStorage

            if (!username) return;

            try {
                const response = await fetch("http://98.83.63.33:5006/recent-searches?username=" + username);
                const data = await response.json();

                const recommendedContainer = document.getElementById("recommended-container");
                recommendedContainer.innerHTML = "";  // Clear previous results

                // Call fetchModelByName for each recent search
                for (let search of data) {
                    await fetchModelByName(search.firstModelName);  // Pass the first model's name to fetch it
                }
            } catch (error) {
                console.error("Error fetching recent searches:", error);
            }
        }

        const existingModels = new Set();

        async function fetchModelByName(firstModelName) {
            try {
                const response = await fetch(`http://98.83.63.33:5003/models/${firstModelName}`);
                const data = await response.json();  // Get the response

                const model = data.model;  // Extract the model from the response

                if (model) {
                    const recommendedContainer = document.getElementById("recommended-container");

                    if (!existingModels.has(model.name)) {  // If the model has not been added, display it
                        existingModels.add(model.name);  // Add the model to the set

                        const modelCard = document.createElement("div");
                        modelCard.classList.add("card");
                        modelCard.innerHTML = `
                            <img src="${model.image_url || 'default-image.jpg'}" alt="${model.name}">
                            <h3>${model.name}</h3>
                            <p>${model.description}</p>
                            <p><strong>Created by:</strong> ${model.created_by}</p>
                            <p class="price">$${model.price}</p>
                            <button onclick="window.location.href='details.html?model_id=${model._id}'">View Details</button>
                        `;
                        recommendedContainer.appendChild(modelCard);
                    }
                }
            } catch (error) {
                console.error("Error fetching model by name:", error);
            }
        }

        // Call the function to load recent searches when the page loads
        document.addEventListener('DOMContentLoaded', fetchRecentSearches);


        // Check if the user is logged in
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('token');
            const username = localStorage.getItem('username');

            const userSettings = document.getElementById('user-settings');
            const settingsIcon = document.getElementById('settings-icon');
            const settingsDropdown = document.getElementById('settings-dropdown');
            const loginRegisterLink = document.getElementById('login-register-link');
            const logoutLink = document.getElementById('logout-link');
            
            if (token && username) {
                // Show user settings and username if logged in
                document.getElementById('user-settings').style.display = 'block';
                document.getElementById('username').innerText = username;
                document.getElementById('login-register-link').style.display = 'none';
            } else {
                // Show login/register links if not logged in
                document.getElementById('login-register-link').style.display = 'block';
                document.getElementById('user-settings').style.display = 'none';
            }

            // Toggle dropdown visibility when clicking the settings icon
            settingsIcon.addEventListener('click', (event) => {
                event.stopPropagation(); // Prevent the event from propagating

                userSettings.classList.toggle('open');

                if (userSettings.classList.contains('open')) {
                    const rect = settingsIcon.getBoundingClientRect();
                    const dropdownWidth = settingsDropdown.offsetWidth;
                    const screenWidth = window.innerWidth;

                    if (rect.left + dropdownWidth > screenWidth) {
                        settingsDropdown.style.left = `${rect.left - dropdownWidth + settingsIcon.offsetWidth}px`;
                    } else {
                        settingsDropdown.style.left = `${rect.left}px`;
                    }

                    settingsDropdown.style.top = `${rect.bottom + window.scrollY}px`;
                }
            });

            // Logout function
            logoutLink.addEventListener('click', () => {
                localStorage.removeItem('token');
                localStorage.removeItem('username');
                window.location.href = 'index.html'; // Redirect to home after logout
            });

            const sessionApiUrl = window.config.sessionApiUrl;

            // Session verification logic
            document.addEventListener('DOMContentLoaded', async function() {
                const token = localStorage.getItem('token');
                
                if (token) {
                    try {
                        const response = await fetch(`${sessionApiUrl}/api/sessions/verify`, {
                            method: 'GET',
                            headers: { 'Authorization': `Bearer ${token}` }
                        });

                        const data = await response.json();
                        if (response.ok) {
                            console.log("Session is valid", data);
                        } else {
                            alert('Session expired or invalid, please log in again.');
                            localStorage.removeItem('token');
                            window.location.href = 'login.html';
                        }
                    } catch (error) {
                        console.error('Error verifying session:', error);
                    }
                } else {
                    window.location.href = 'login.html';
                }
            });

            // Close the dropdown if clicked outside
            document.addEventListener('click', (event) => {
                if (!userSettings.contains(event.target) && !settingsIcon.contains(event.target)) {
                    userSettings.classList.remove('open');
                }
            });
        });
    </script>
</body>
</html>